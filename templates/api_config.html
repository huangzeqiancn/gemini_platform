{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm border-0">
    <div class="card-header bg-white text-dark">
        <ul class="nav nav-tabs card-header-tabs" id="configTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active fw-bold" id="api-tab" data-bs-toggle="tab" data-bs-target="#api-pane">API å¯†é’¥ç®¡ç†</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold" id="template-tab" data-bs-toggle="tab" data-bs-target="#template-pane">è§£ææ¨¡æ¿ (Schema)</button>
            </li>
            <li class="nav-item">
                <button class="nav-link fw-bold" id="preset-tab" data-bs-toggle="tab" data-bs-target="#preset-pane">ç³»ç»ŸæŒ‡ä»¤é¢„è®¾</button>
            </li>
        </ul>
    </div>
    <div class="card-body tab-content">
        <div class="tab-pane fade show active" id="api-pane">
            <div class="row">
                <div class="col-md-4">
                    <h6 class="mb-3 fw-bold">æ·»åŠ  API é…ç½®</h6>
                    <form action="/api_config/add" method="post" class="bg-light p-3 rounded shadow-sm border">
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">é…ç½®åç§°</label>
                            <input type="text" name="name" class="form-control form-control-sm" placeholder="ä¾‹å¦‚ï¼šå…¬å¸å†…ç½‘AI" required>
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">Base URL</label>
                            <input type="url" id="input_base_url" name="base_url" class="form-control form-control-sm" placeholder="https://..." required>
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold text-muted">API Key / Secret</label>
                            <input type="password" id="input_api_key" name="api_key" class="form-control form-control-sm" required>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold text-muted">User ID (HMAC ä¸“ç”¨)</label>
                            <input type="text" id="input_api_user" name="api_user" class="form-control form-control-sm" placeholder="éHMACåè®®å¯ä¸å¡«">
                        </div>
                        <button type="submit" class="btn btn-primary btn-sm w-100 shadow-sm">ä¿å­˜é…ç½®</button>
                    </form>
                </div>
                <div class="col-md-8">
                    <h6 class="mb-3 fw-bold">å·²ä¿å­˜å¯†é’¥</h6>
                    <table class="table table-hover align-middle border">
                        <thead class="table-light">
                            <tr><th>åç§°</th><th>é‰´æƒæ¨¡å¼</th><th>Base URL</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            {% for cfg in configs %}
                            <tr>
                                <td><strong>{{ cfg.name }}</strong></td>
                                <td>
                                    {% if cfg.api_user %}
                                    <span class="badge bg-info text-dark"><i class="fas fa-lock"></i> HMAC ({{ cfg.api_user }})</span>
                                    {% else %}
                                    <span class="badge bg-light text-muted border"><i class="fas fa-key"></i> Standard</span>
                                    {% endif %}
                                </td>
                                <td><small class="text-muted">{{ cfg.base_url }}</small></td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-primary btn-sm" onclick="editApi({{ cfg.id }})">ç¼–è¾‘</button>
                                        <form action="/api_config/delete/{{ cfg.id }}" method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ');" style="display:inline;">
                                            <button type="submit" class="btn btn-outline-danger btn-sm">åˆ é™¤</button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="template-pane">
            <div class="row">
                <div class="col-md-5">
                    <h6 class="mb-3 fw-bold text-primary">åˆ›å»ºè§£ææ¨¡æ¿</h6>
                    <form action="/templates/add" method="post" class="bg-light p-3 rounded shadow-sm border border-primary mb-4">
                        <div class="mb-3">
                            <label class="small fw-bold">æ¨¡æ¿åç§°</label>
                            <input type="text" name="name" class="form-control" placeholder="å¦‚ï¼šHMACå“åº”æ¨¡æ¿" required>
                        </div>
                        <div class="mb-3">
                            <label class="small fw-bold">æ˜ å°„è§„åˆ™ (JSON Path)</label>
                            <textarea name="mapping_rules" id="template_rules" class="form-control font-monospace" rows="4">{"answer": "choices.0.message.content", "tokens": "usage.total_tokens"}</textarea>
                            <div class="mt-2">
                                <span class="badge bg-secondary" onclick="fillTemplate('openai')" style="cursor:pointer">OpenAI æ ‡å‡†</span>
                                <span class="badge bg-dark" onclick="fillTemplate('hmac')" style="cursor:pointer">HMAC é»˜è®¤</span>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">ä¿å­˜æ¨¡æ¿</button>
                    </form>

                    <h6 class="fw-bold mb-3">æ¥å£æ¢æµ‹å®éªŒå®¤ (Lab)</h6>
                    <div class="p-3 bg-dark text-white rounded shadow">
                        <p class="text-info mb-3 small"><i class="fas fa-flask"></i> æ¨¡æ‹ŸçœŸå®è¯·æ±‚è·å– JSON ç»“æ„</p>

                        <div class="mb-3">
                            <label class="d-block mb-1 text-muted" style="font-size: 0.75rem;">æµ‹è¯•æ¨¡å‹åç§° (model_marker / model)</label>
                            <input type="text" id="test_model_name" 
                                   class="form-control form-control-sm bg-secondary text-white border-0" 
                                   style="background-color: #2d3748 !important;"
                                   placeholder="ä¾‹å¦‚: api_google_gemini-3-pro-preview">
                        </div>
                        
                        <div class="mb-3">
                            <label class="d-block mb-1 text-muted" style="font-size: 0.75rem;">é€‰æ‹© API é…ç½®</label>
                            <select id="lab_api_selector" class="form-select form-select-sm bg-secondary text-white border-0">
                                <option value="new">-- ä½¿ç”¨å·¦ä¾§â€œæ·»åŠ  APIâ€å¤„è¾“å…¥çš„å†…å®¹ --</option>
                                {% for cfg in configs %}
                                <option value="{{ cfg.id }}" data-url="{{ cfg.base_url }}" data-key="{{ cfg.api_key }}" data-user="{{ cfg.api_user }}">
                                    {{ cfg.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="d-block mb-1 text-muted" style="font-size: 0.75rem;">æ¢æµ‹åè®®ç±»å‹</label>
                            <select id="lab_platform" class="form-select form-select-sm bg-secondary text-white border-0">
                                <option value="official">æ ‡å‡†/å®˜æ–¹åè®® (Bearer)</option>
                                <option value="api_hmac">ç§æœ‰ HMAC åè®®</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-sm btn-info w-100 fw-bold mt-2 text-dark" onclick="runApiTest()">æ‰§è¡Œæ¢æµ‹è¯·æ±‚</button>
                    </div>
                </div>

                <div class="col-md-7">
                    <h6 class="mb-3 fw-bold">å·²å­˜æ¨¡æ¿åˆ—è¡¨</h6>
                    <div class="bg-light border rounded p-3 mb-3">
                        <table class="table table-sm small">
                            <thead><tr><th>æ¨¡æ¿åç§°</th><th>è§„åˆ™å†…å®¹</th><th>æ“ä½œ</th></tr></thead>
                            <tbody>
                                {% for t in templates %}
                                <tr>
                                    <td>{{ t.name }}</td>
                                    <td><code>{{ t.mapping_rules }}</code></td>
                                    <td>
                                        <form action="/templates/delete/{{ t.id }}" method="post" onsubmit="return confirm('åˆ é™¤æ¨¡æ¿ï¼Ÿ');">
                                            <button type="submit" class="btn btn-link btn-sm text-danger p-0">åˆ é™¤</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <hr>
                        <h6 class="small text-muted fw-bold">æ¢æµ‹å®æ—¶è¿”å› (JSON):</h6>
                        <pre id="json_output" class="small bg-white p-2 border" style="min-height: 200px; max-height: 450px; overflow-y: auto; color: #2d3748;">ç­‰å¾…è¯·æ±‚æ•°æ®...</pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="preset-pane">
            <div class="row">
                <div class="col-md-4">
                    <h6 class="mb-3 fw-bold text-success">åˆ›å»ºæ–°é¢„è®¾</h6>
                    <form action="/presets/add" method="post" class="bg-light p-3 rounded shadow-sm border border-success">
                        <div class="mb-2">
                            <label class="small fw-bold">é¢„è®¾åç§°</label>
                            <input type="text" name="name" class="form-control form-control-sm" required>
                        </div>
                        <div class="mb-2">
                            <label class="small fw-bold">æŒ‡ä»¤å†…å®¹</label>
                            <textarea name="content" class="form-control form-control-sm" rows="6" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm w-100 shadow-sm">æ·»åŠ é¢„è®¾</button>
                    </form>
                </div>
                <div class="col-md-8">
                    <h6 class="mb-3 fw-bold text-success">é¢„è®¾åˆ—è¡¨åº“</h6>
                    <div class="row row-cols-1 row-cols-md-2 g-3">
                        {% for pre in presets %}
                        <div class="col">
                            <div class="card h-100 border-start border-4 border-success shadow-sm">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="card-title fw-bold text-success mb-0">{{ pre.name }}</h6>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light border" type="button" data-bs-toggle="dropdown">â€¢â€¢â€¢</button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="editPreset({{ pre.id }})">ç¼–è¾‘é¢„è®¾</a></li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <form action="/presets/delete/{{ pre.id }}" method="post" onsubmit="return confirm('åˆ é™¤æ­¤é¢„è®¾ï¼Ÿ');">
                                                        <button type="submit" class="dropdown-item text-danger">åˆ é™¤</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <p class="card-text small text-muted text-truncate">{{ pre.content }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="apiModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/api_config/update" method="post" class="modal-content">
            <div class="modal-header"><h5>ç¼–è¾‘ API é…ç½®</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" name="cfg_id" id="api_id">
                <div class="mb-3"><label class="form-label small fw-bold">åç§°</label><input type="text" name="name" id="api_name" class="form-control"></div>
                <div class="mb-3"><label class="form-label small fw-bold">Base URL</label><input type="url" name="base_url" id="api_url" class="form-control"></div>
                <div class="mb-3"><label class="form-label small fw-bold">API Key / Secret</label><input type="text" name="api_key" id="api_key_edit" class="form-control"></div>
                <div class="mb-3"><label class="form-label small fw-bold">User ID (HMACä¸“ç”¨)</label><input type="text" name="api_user" id="api_user_edit" class="form-control"></div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button></div>
        </form>
    </div>
</div>

<div class="modal fade" id="presetModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/presets/update" method="post" class="modal-content">
            <div class="modal-header bg-success text-white"><h5 class="modal-title">ç¼–è¾‘é¢„è®¾</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" name="pre_id" id="edit_modal_id">
                <div class="mb-3"><label class="form-label fw-bold small">åç§°</label><input type="text" name="name" id="edit_modal_name" class="form-control" required></div>
                <div class="mb-3"><label class="form-label fw-bold small">å†…å®¹</label><textarea name="content" id="edit_modal_content" class="form-control" rows="8" required></textarea></div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-success">æ›´æ–°</button></div>
        </form>
    </div>
</div>

<script>
function fillTemplate(type) {
    const textarea = document.getElementById('template_rules');
    if (type === 'openai') {
        textarea.value = JSON.stringify({"answer": "choices.0.message.content", "tokens": "usage.total_tokens"}, null, 2);
    } else {
        textarea.value = JSON.stringify({"answer": "answer.0.value", "tokens": "cost_info.total_tokens"}, null, 2);
    }
}

async function runApiTest() {
    const output = document.getElementById('json_output');
    const selector = document.getElementById('lab_api_selector');
    const selectedOption = selector.options[selector.selectedIndex];
    const model = document.getElementById('test_model_name').value.trim();

    if (!model) {
        return alert("è¯·è¾“å…¥æµ‹è¯•æ¨¡å‹åç§° (å¦‚: gpt-3.5-turbo)ï¼");
    }
    
    let base_url, api_key, api_user;
    if (selector.value === "new") {
        base_url = document.getElementById('input_base_url').value;
        api_key = document.getElementById('input_api_key').value;
        api_user = document.getElementById('input_api_user').value;
    } else {
        base_url = selectedOption.getAttribute('data-url');
        api_key = selectedOption.getAttribute('data-key');
        api_user = selectedOption.getAttribute('data-user');
    }

    const platform_type = document.getElementById('lab_platform').value;

    if (!base_url || !api_key) {
        return alert("è¯·é€‰æ‹©ä¸€ä¸ª API æˆ–åœ¨å·¦ä¾§å¡«å†™é…ç½®ä¿¡æ¯ï¼");
    }

    output.innerText = "ğŸš€ æ­£åœ¨å»ºç«‹è¿æ¥å¹¶æ‰§è¡Œç­¾åè¯·æ±‚...";
    try {
        const res = await fetch('/api_config/test', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ base_url, api_key, api_user, platform_type, model })
        });
        const data = await res.json();
        output.innerText = JSON.stringify(data, null, 4);
    } catch (err) {
        output.innerText = "âŒ æ¢æµ‹å¤±è´¥: " + err;
    }
}

async function editApi(id) {
    try {
        const res = await fetch(`/api_config/get/${id}`);
        const data = await res.json();
        document.getElementById('api_id').value = data.id;
        document.getElementById('api_name').value = data.name;
        document.getElementById('api_url').value = data.base_url;
        document.getElementById('api_key_edit').value = data.api_key;
        document.getElementById('api_user_edit').value = data.api_user || '';
        new bootstrap.Modal(document.getElementById('apiModal')).show();
    } catch (err) { alert("è·å–æ•°æ®å¤±è´¥"); }
}

async function editPreset(id) {
    try {
        const res = await fetch(`/presets/get/${id}`);
        const data = await res.json();
        document.getElementById('edit_modal_id').value = data.id;
        document.getElementById('edit_modal_name').value = data.name;
        document.getElementById('edit_modal_content').value = data.content;
        bootstrap.Modal.getOrCreateInstance(document.getElementById('presetModal')).show();
    } catch (err) { alert("è·å–é¢„è®¾å¤±è´¥"); }
}

document.addEventListener("DOMContentLoaded", function() {
    const hash = window.location.hash;
    if (hash) {
        const triggerEl = document.querySelector(`button[data-bs-target="${hash}"]`);
        if (triggerEl) bootstrap.Tab.getOrCreateInstance(triggerEl).show();
    }
});
</script>

<style>
    /* ä¿®æ­£è¾“å…¥æ¡†åœ¨æš—é»‘èƒŒæ™¯ä¸‹çš„è§†è§‰æ•ˆæœ */
    #test_model_name:focus {
        background-color: #1a202c !important;
        color: #fff !important;
        border-color: #4fd1c5;
        box-shadow: 0 0 0 0.2rem rgba(79, 209, 197, 0.25);
    }
    #json_output { 
        font-family: 'Fira Code', 'Courier New', monospace; 
        border-radius: 6px; 
        background-color: #f8fafc;
    }
</style>
{% endblock %}